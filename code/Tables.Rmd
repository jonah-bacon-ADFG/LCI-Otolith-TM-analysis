---
title: "LCI_HatcheryTM_ReportTablesFigures"
author: "Jonah Bacon"
date: "`r Sys.Date()`"
output: 
  html_document:
      toc: true
      toc_float:
        collapsed: false
        smooth_scroll: true
---

This code analyzes data collected from 2018-2022 as part of the Thermal Mark Hatchery Salmon Otoliths in Lower Cook Inlet project (*REGIONAL OPERATIONAL PLAN NO. ROP.CF.2A.2023.XX*). Data, scripts, and associated files are located in the Homer LAN network: ```O:\DCF\SALMON\OTOLITH_STUDIES\1_ANALYSES\2018-2022```. Data are first cleaned, edited (when commercial harvest was misreported or errors in recording occurred), and then analyzed for Pink Salmon followed by identical analysis for Sockeye Salmon.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_knit$set(root.dir = "C:/Users/jabacon/Documents/2018-2022")

# Load libraries
library(tidyverse)
```

```{r loaddata}
load("code/LCI_HatcheryTM_data.RData")
```

# Tables
## 2

Table 2.–Summary of commercial harvest and cost recovery samples collected in the Southern District, 2018–2022.

```{r table2}
table2 <- select(pink.marks, c(HomerSampleID,Year,Species,Source,StatWeek,StatArea,Gear,Rcvd,Preps)) %>% 
  full_join(select(reds.marks, c(HomerSampleID,Year,Species,Source,StatWeek,StatArea,Gear,Rcvd,Preps))) %>% 
  filter(!Source %in% c("ESCAPEMENT SURVEY","RACK RETURN")) %>% 
  replace_na(list(Rcvd = 0)) %>% 
  group_by(HomerSampleID,Year,Species,Source,StatWeek,StatArea,Gear) %>% 
  summarise(N.samples = max(Rcvd,Preps)) %>% 
  group_by(Year,Species,Gear,Source) %>% 
  summarise(N.events = length(unique(HomerSampleID)), N.samples = sum(N.samples)) %>% 
  mutate(Source = ifelse(Source == "COMMERCIAL COM PROP","CCP",
                         ifelse(Source == "COST RECOVERY","CR",Source)),
         Species = ifelse(Species == "SOCKEYE","Sockeye",
                         ifelse(Species == "PINK","Pink",Species)),
         Gear = ifelse(Gear == "SET GILLNET","SGN",
                         ifelse(Gear == "PURSE SEINE","PS",Gear))) %>% 
  pivot_wider(names_from = Source, values_from = c(N.events,N.samples)) %>% 
  rename(CCP.N.events = N.events_CCP,
         CCP.N.samples = N.samples_CCP,
         CR.N.events = N.events_CR,
         CR.N.samples = N.samples_CR) %>% 
  replace_na(list(CR.N.events = 0,CR.N.samples = 0)) %>% 
  select(Year,Species,Gear,CCP.N.events,CCP.N.samples,CR.N.events,CR.N.samples) %>% 
  mutate(Sum.N.events = CCP.N.events + CR.N.events,
         Sum.N.samples = CCP.N.samples + CR.N.samples) %>% 
  arrange(Year,desc(Species),desc(Gear))
```


```{r table3&4}
## Sampled Harvest Summary Table is similar to the one that is currently in the report but slightly different numbers
sampled.harvest.SUMMARY <- sampled.harvest.CLEAN %>% 
  separate(Year_StatWk_Gear, into = c("Year","StatWk","Gear"), sep = "_") %>% 
  mutate(UnsampledHarvest = ifelse(is.na(HomerID),CommercialHarvest,NA),
         SampledHarvest = ifelse(!is.na(HomerID),CommercialHarvest,NA)) %>% 
  group_by(Year,StatWk,Gear,Source,StatArea,Species) %>% 
  summarise(CommercialHarvest = unique(CommercialHarvest),SampledHarvest = unique(SampledHarvest), UnsampledHarvest = unique(UnsampledHarvest)) %>% 
  group_by(Species,Year,Source,Gear) %>% 
  summarise(N.Sampled = sum(!is.na(SampledHarvest)), 
            TotalSampledHarvest = sum(SampledHarvest,na.rm = T),
            N.Unsampled = sum(!is.na(UnsampledHarvest)),
            TotalUnsampledHarvest = sum(UnsampledHarvest,na.rm = T),
            TotalCommercialHarvest = sum(CommercialHarvest),
            SampledProportion = round(TotalSampledHarvest/TotalCommercialHarvest*100,1)) %>% 
  arrange(Year,desc(Source),Gear)

table3 <- filter(sampled.harvest.SUMMARY, Species == "Sockeye")
table4 <- filter(sampled.harvest.SUMMARY, Species == "Pink")
```

```{r}
full.data.reds <- reds.clean %>% 
  select(HomerSampleID,Year_StatWk_Gear,Source,StatArea,Preps,NotMarked,Marked,LCI,PWS,KOD,Other) %>% 
  right_join(sampled.harvest.CLEAN,
            by = join_by(HomerSampleID == HomerID,
                         Year_StatWk_Gear == Year_StatWk_Gear,
                         Source == Source,
                         StatArea == StatArea)) %>% 
  mutate(HomerSampleID = ifelse(is.na(Preps) & !is.na(HomerSampleID),NA,HomerSampleID)) %>% 
  filter(Species == "Sockeye")

pink.clean <- pink.clean %>% 
  mutate(StatArea = as.character(StatArea),
         StatArea = ifelse(HomerSampleID == "19PSD041P",24193,StatArea),
         StatArea = ifelse(HomerSampleID == "19PSD045P",24191,StatArea),
         StatArea = ifelse(HomerSampleID == "19PSD066P",24193,StatArea),
         StatArea = ifelse(HomerSampleID == "19PSD068P",24106,StatArea),
         StatArea = as.factor(StatArea)) %>% 
  filter(HomerSampleID != "19HMS090P")

sampled.harvest.CLEAN <- sampled.harvest.CLEAN %>% 
  mutate(StatArea = as.character(StatArea),
         StatArea = ifelse(HomerID == "20PSD072P","24106",StatArea),
         StatArea = ifelse(HomerID == "20PSD073P","24107",StatArea),
         StatArea = as.factor(StatArea)) 

full.data.pink <- pink.clean %>% 
  select(HomerSampleID,Year_StatWk_Gear,Source,StatArea,Preps,NotMarked,Marked,LCI,PWS,KOD,Other) %>% 
  left_join(sampled.harvest.CLEAN,
            by = join_by(HomerSampleID == HomerID,
                         Year_StatWk_Gear == Year_StatWk_Gear,
                         Source == Source,
                         StatArea == StatArea)) %>% 
  mutate(HomerSampleID = ifelse(is.na(Preps) & !is.na(HomerSampleID),NA,HomerSampleID)) %>% 
  filter(Species == "Pink")

full.data <- full.data.reds %>% 
  full_join(full.data.pink,
            by = join_by(HomerSampleID == HomerSampleID,
                         Source == Source,
                         StatArea == StatArea,
                         Year_StatWk_Gear == Year_StatWk_Gear,
                         Species == Species,
                         CommercialHarvest == CommercialHarvest,
                         Preps == Preps,
                         NotMarked == NotMarked,
                         Marked == Marked,
                         LCI == LCI,
                         PWS == PWS,
                         KOD == KOD,
                         Other == Other)) %>% 
  separate(Year_StatWk_Gear, into = c("Year","StatWk","Gear"), sep = "_") %>% 
  mutate(StatArea = as.character(StatArea)) %>% 
  mutate(StatArea = ifelse(Gear == "SGN","24100",StatArea)) %>% 
  mutate(StatArea = as.factor(StatArea)) %>% 
  pivot_longer(cols = c(LCI,PWS,KOD,Other), names_to = "HatcheryRegion",values_to = "Count") %>% 
  replace_na(list(Preps = 0, NotMarked = 0, Marked = 0, Count = 0))

## Estimating hatchery contribution of commercial harvest records that samples came from:
sampled.data <- full.data %>% 
  filter(!is.na(HomerSampleID)) %>% 
  group_by(Year,StatWk,Gear,Source,StatArea,Species,CommercialHarvest,HatcheryRegion) %>% 
  summarise(Preps = sum(Preps),NotMarked = sum(NotMarked),Marked = sum(Marked),Count = sum(Count)) %>% 
  group_by(Year,StatWk,Gear,Source,StatArea,Species,HatcheryRegion) %>% 
  summarise(CommercialHarvest = sum(CommercialHarvest),Preps = sum(Preps),NotMarked = sum(NotMarked),Marked = sum(Marked),Count = sum(Count)) %>% 
  mutate(Proportion = round(Count/(NotMarked+Marked),3), PortionHarvest = round(Proportion*CommercialHarvest,1))

sampled.data.simple <- sampled.data %>% 
  select(Year,StatWk,Gear,Source,StatArea,Species,HatcheryRegion,CommercialHarvest,Preps,NotMarked,Marked,Count,Proportion) %>% 
  rename(SampleCommercialHarvest = CommercialHarvest)

## Creating data frame of instances where commercial harvest records did not have a sample observation linked to them:
harvest.wo.sample <- full.data %>% 
  filter(is.na(HomerSampleID)) %>% 
  select(-c(HomerSampleID,Preps,NotMarked,Marked,Count)) %>% 
  group_by(Year,StatWk,Gear,Source,StatArea,Species,HatcheryRegion) %>% 
  summarise(CommercialHarvest = sum(CommercialHarvest)) %>% 
  left_join(sampled.data.simple,
            by = join_by(Year == Year,
                         StatWk == StatWk,
                         Gear == Gear,
                         Source == Source,
                         StatArea == StatArea,
                         Species == Species,
                         HatcheryRegion == HatcheryRegion))

## Estimating hatchery contribution to strata that had both harvest recorded and sampling:
harvest.w.corresp.sample <- harvest.wo.sample %>% 
  filter(!is.na(Proportion)) %>% 
  mutate(PortionHarvest = round(Proportion*CommercialHarvest,1))

## Create data frame where strata had harvest occur but no sampling:
harvest.wo.corresp.sample <- harvest.wo.sample %>% 
  filter(is.na(Proportion)) %>% 
  select(-Proportion)

# Create data frame where sample data for a strata is pooled across StatWk's to create annual average hatchery contribution:
sampled.data.pooledStatWk <- sampled.data %>% 
  select(-c(CommercialHarvest,Proportion,PortionHarvest)) %>% 
  group_by(Year,Gear,Source,StatArea,Species,HatcheryRegion) %>% 
  summarise(Preps = sum(Preps),NotMarked = sum(NotMarked),Marked = sum(Marked),Count = sum(Count)) %>% 
  mutate(Proportion = round(Count/(NotMarked+Marked),3)) %>% 
  select(-c(Preps,NotMarked,Marked,Count))

# Assign annual average hatchery contribution for each StatArea to strata where harvest occurred but no sampling occurred:
harvest.wo.corresp.sample.pooledStatWk <- harvest.wo.corresp.sample %>% 
  left_join(sampled.data.pooledStatWk,
            by = join_by(Year == Year,
                         Gear == Gear,
                         Source == Source,
                         StatArea == StatArea,
                         Species == Species,
                         HatcheryRegion == HatcheryRegion)) %>% 
  mutate(PortionHarvest = round(Proportion*CommercialHarvest,1))

# Create data frame with hatchery contribution of harvest to strata pooled across StatWk:
harvest.wo.corresp.sample.pooledStatWk.GOOD <- harvest.wo.corresp.sample.pooledStatWk %>% 
  filter(!is.na(Proportion))

# Create data frame where harvest occurred in strata but no sampling occurred for that StatArea across any StatWk's:
harvest.wo.corresp.sample.pooledStatWk.MISSING <- harvest.wo.corresp.sample.pooledStatWk %>% 
  filter(is.na(Proportion)) %>% 
  select(-Proportion)

# Create data frame where sample data for a strata is pooled across StatWk's and StatArea's to create annual hatchery contribution in all LCI StatArea:
sampled.data.pooledStatWkStatArea <- sampled.data %>% 
  select(-c(CommercialHarvest,Proportion,PortionHarvest)) %>% 
  group_by(Year,Gear,Source,Species,HatcheryRegion) %>% 
  summarise(Preps = sum(Preps),NotMarked = sum(NotMarked),Marked = sum(Marked),Count = sum(Count)) %>% 
  mutate(Proportion = round(Count/(NotMarked+Marked),3)) %>% 
  select(-c(Preps,NotMarked,Marked,Count))

harvest.w.NO.pooledsample <- harvest.wo.corresp.sample.pooledStatWk.MISSING %>% 
  left_join(sampled.data.pooledStatWkStatArea,
            by = join_by(Year == Year,
                         Gear == Gear,
                         Source == Source,
                         Species == Species,
                         HatcheryRegion == HatcheryRegion)) %>% 
  mutate(PortionHarvest = round(Proportion*CommercialHarvest,1))
  
```


```{r table5}
full.C.hat_hi <- sampled.data %>% 
  rename(C.hat_hi = PortionHarvest) %>% 
  mutate(C.hat_hi_VAR = (CommercialHarvest^2)*(1/((NotMarked+Marked)-1))*(Count/(NotMarked+Marked))*(1 - (Count/(NotMarked+Marked))))

full.C.hat_Sh <- full.C.hat_hi %>% 
  group_by(Year,StatWk,Gear,Source,Species,HatcheryRegion) %>% 
  summarize(C.hat_Sh = sum(C.hat_hi), # EQUATION 3: Estimate of contribution of hatchery mark (h) to all sampled CCP harvests.
            C.hat_Sh_VAR = sum(C.hat_hi_VAR)) %>% # EQUATION 4: Variance estimate of C.hat_Sh
  mutate(C.hat_Sh_sd = sqrt(C.hat_Sh_VAR),
         Lower.95.CI = C.hat_Sh - 1.96*C.hat_Sh_sd,
         Upper.95.CI = C.hat_Sh + 1.96*C.hat_Sh_sd)
  
full.C.hat_Uh <- harvest.w.corresp.sample %>% 
  rename(C.hat_Uh = PortionHarvest)

full.C.hat_h <- full.C.hat_Sh %>% 
  full_join(full.C.hat_Uh,
            by = join_by(Year, StatWk, Gear, Source, Species, HatcheryRegion))

full.C.hat_hi <- sampled.data %>% 
  full_join(harvest.w.corresp.sample,
            by = join_by(Year, StatWk, Gear, Source, StatArea, Species, HatcheryRegion, CommercialHarvest, Preps, NotMarked, Marked, Count, Proportion, PortionHarvest)) %>%
  rename(C.hat_hi = PortionHarvest) %>% 
  mutate(C.hat_hi_VAR = (CommercialHarvest^2)*(1/((NotMarked+Marked)-1))*(Count/(NotMarked+Marked))*(1 - (Count/(NotMarked+Marked))))

full.C.hat_Sh <- full.C.hat_hi %>% 
  group_by(Year,StatWk,Gear,Source,Species,HatcheryRegion) %>% 
  summarize(C.hat_Sh = sum(C.hat_hi), # EQUATION 3: Estimate of contribution of hatchery mark (h) to all sampled CCP harvests.
            C.hat_Sh_VAR = sum(C.hat_hi_VAR)) # EQUATION 4: Variance estimate of C.hat_Sh
```

```{r table2}

```